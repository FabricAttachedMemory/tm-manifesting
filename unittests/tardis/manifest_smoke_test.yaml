metadata:
    maintainer:
        - name: Zach Volchak
          email: zakhar.volchak@hpe.com
    notes: |

infrastructure:
    - host:
        name: bm-test
        deploy-from: tardis
        deploy-options: mem:8192,cpu:2,disk:8,isoName:qa-l4tm-tot-amd64.iso,dev:sda
        deploy-type: vm
        name: tm-vm

defaults:
    shell:
        failaction: fail, continue
        passaction: continue
        rcpass: rc==0
    execute:
        failaction: fail, continue
        passaction: continue
        rcpass: rc>=1

blocks:
    test_install:
         - shell: echo $REPO
         - shell: env
         - shell: echo "${REPO}" >> /etc/apt/sources.list
         - shell: cat /etc/apt/sources.list
         - shell: apt -y update
         - shell: apt -y upgrade
         - shell: apt --assume-yes --force-yes install -t manifesting-catapult tm-manifesting
         - shell: apt-cache show tm-manifesting

    test_symlinks:
        - shell: ls -l /usr/bin/tm-manifest-server
        - shell: ls -l /usr/bin/tm-manifest
        - shell: ls -l /lib/systemd/system/tm-manifest-server.service
        - shell: ls -l /usr/default/tm-manifest-server

    test_python_env:
        - shell: ls -l /usr/lib/python3/dist-packages/tmms/
        - shell: ls -l /usr/lib/python3/dist-packages/tmms/blueprints/
        - shell: ls -l /usr/lib/python3/dist-packages/tmms/tm_cmd/
        - shell: ls -l /usr/lib/python3/dist-packages/tmms/unittests/

    test_postrm:
        - execute: ls -l /usr/bin/tm-manifest-server
        - execute: ls -l /usr/bin/tm-manifest
        - execute: ls -l /lib/systemd/system/tm-manifest-server.service
        - execute: ls -l /usr/lib/python3/dist-packages/tmms/
        - shell: ls -l /etc/tmms.purge

test:
- step:
    tm-vm:
        - deploy: tm-vm
        - test_install
        - test_symlinks
        - test_python_env
        - shell: apt purge --yes --force-yes --assume-yes tm-manifesting
        - test_postrm
