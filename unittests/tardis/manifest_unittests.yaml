metadata:
    maintainer:
        - name: Zach Volchak
          email: zakhar.volchak@hpe.com
    notes: |

infrastructure:
    - host:
        name: bm-test
        deploy-from: tardis
        deploy-options: mem:8192,cpu:2,disk:15,isoName:qa-l4tm-tot-amd64.iso,dev:sda
        deploy-type: vm
        name: tm-vm

defaults:
    shell:
        failaction: fail, continue
        passaction: continue
        rcpass: rc==0

#TODO: THIS IS NOT A VALID TEST, YET

blocks:
    test_install:
         - shell: env
         - shell: echo "${REPO}" >> /etc/apt/sources.list
         - shell: cat /etc/apt/sources.list
         - shell: apt -y update
         - shell: apt -y upgrade
         - shell: apt --assume-yes --force-yes install -t manifesting-catapult tm-manifesting
         - shell: apt-cache show tm-manifesting

    test_setup_golden:
        - shell: tm-manifest-setup all
        - shell: ls -l /var/lib/tmms/sys-images/golden/golden.arm.tar
        - shell: cat /lib/systemd/system/tm-manifest-server.service


    test_unittest:
        - shell: systemctl start tm-manifest-server
        - shell: sleep 30
        - shell: systemctl status tm-manifest-server
        - shell: cd /usr/lib/python3/dist-packages/tmms/unittests/
        - shell: ./test_all.sh
        - shell: systemctl stop tm-manifest-server
        - shell: systemctl status tm-manifest-server

test:
- step:
    tm-vm:
        - deploy: tm-vm
        - test_install
        - test_setup_golden
        - test_unittest
